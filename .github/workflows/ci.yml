name: Pipeline CI

on:
  pull_request:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'terraform/**'
      - 'requirements.txt'
      - '.github/workflows/**'
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'terraform/**'
      - 'requirements.txt'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  python-lint:
    name: Python Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint flake8 black

      - name: Check Python syntax
        run: |
          echo "ðŸ” Checking Python syntax..."
          python -m py_compile scripts/*.py

      - name: Run flake8
        continue-on-error: true
        run: |
          echo "ðŸ” Running flake8..."
          flake8 scripts/ --max-line-length=100 --ignore=E501,W503

      - name: Check code formatting with black
        continue-on-error: true
        run: |
          echo "ðŸ” Checking code formatting..."
          black --check --line-length=100 scripts/

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Terraform Format Check
        run: |
          echo "ðŸ” Checking Terraform formatting..."
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate

  json-validation:
    name: Validate JSON Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate prompt configurations
        run: |
          echo "ðŸ“‹ Validating JSON files..."

          INVALID_COUNT=0

          # Check all JSON files in prompts/
          for config in prompts/*.json; do
            if [ -f "$config" ]; then
              echo "Validating: $config"

              # Validate JSON syntax
              if ! jq empty "$config" 2>/dev/null; then
                echo "âŒ Invalid JSON syntax: $config"
                INVALID_COUNT=$((INVALID_COUNT + 1))
                continue
              fi

              # Validate required fields
              REQUIRED_FIELDS=("template" "output_name")

              for field in "${REQUIRED_FIELDS[@]}"; do
                VALUE=$(jq -r ".$field // empty" "$config")
                if [ -z "$VALUE" ]; then
                  echo "âŒ Missing required field '$field' in $config"
                  INVALID_COUNT=$((INVALID_COUNT + 1))
                fi
              done

              # Check if template file exists
              TEMPLATE=$(jq -r '.template // empty' "$config")
              if [ -n "$TEMPLATE" ]; then
                if [ ! -f "prompt_templates/$TEMPLATE" ]; then
                  echo "âš ï¸  Warning: Template file not found: prompt_templates/$TEMPLATE"
                fi
              fi

              # Validate output_format if specified
              OUTPUT_FORMAT=$(jq -r '.output_format // empty' "$config")
              if [ -n "$OUTPUT_FORMAT" ] && [ "$OUTPUT_FORMAT" != "html" ] && [ "$OUTPUT_FORMAT" != "md" ]; then
                echo "âŒ Invalid output_format in $config: must be 'html' or 'md'"
                INVALID_COUNT=$((INVALID_COUNT + 1))
              fi
            fi
          done

          if [ $INVALID_COUNT -eq 0 ]; then
            echo "âœ… All JSON files are valid"
          else
            echo "âŒ Found $INVALID_COUNT error(s) in JSON files"
            exit 1
          fi

  security-check:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          echo "ðŸ” Scanning for exposed secrets..."

          # Check for common secret patterns
          if grep -r -i -E "(aws_access_key_id|aws_secret_access_key|password|secret)" \
             --include="*.py" --include="*.json" --include="*.tf" . | grep -v "description\|comment\|variable"; then
            echo "âš ï¸  Potential secrets found in code"
            echo "Please review the matches above"
          else
            echo "âœ… No secrets detected"
          fi

      - name: Check for hardcoded credentials
        run: |
          echo "ðŸ” Checking for hardcoded credentials..."

          # Pattern for AWS access keys
          if grep -r -E "AKIA[0-9A-Z]{16}" --include="*.py" --include="*.json" --include="*.tf" .; then
            echo "âŒ Found hardcoded AWS access keys"
            exit 1
          fi

          echo "âœ… No hardcoded credentials found"

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          echo "ðŸ“š Checking documentation..."

          if [ ! -f "README.md" ]; then
            echo "âŒ README.md not found"
            exit 1
          fi

          if [ ! -f "SETUP_GUIDE.md" ]; then
            echo "âš ï¸  SETUP_GUIDE.md not found"
          fi

          echo "âœ… Documentation files present"

      - name: Check for broken links in README
        continue-on-error: true
        run: |
          echo "ðŸ”— Checking for broken internal links..."

          # Extract markdown links
          grep -o '\[.*\]([^)]*\.md)' README.md | grep -o '([^)]*.md)' | tr -d '()' | while read -r link; do
            if [ ! -f "$link" ]; then
              echo "âš ï¸  Broken link: $link"
            fi
          done

  file-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required directories
        run: |
          echo "ðŸ“ Validating project structure..."

          REQUIRED_DIRS=(
            "prompts"
            "prompt_templates"
            "outputs"
            "scripts"
            ".github/workflows"
          )

          MISSING_COUNT=0

          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âŒ Missing required directory: $dir"
              MISSING_COUNT=$((MISSING_COUNT + 1))
            else
              echo "âœ… $dir/"
            fi
          done

          if [ $MISSING_COUNT -gt 0 ]; then
            echo "âŒ Missing $MISSING_COUNT required director(ies)"
            exit 1
          fi

      - name: Check required files
        run: |
          REQUIRED_FILES=(
            "requirements.txt"
            "README.md"
            ".gitignore"
            "scripts/process_prompt.py"
          )

          MISSING_COUNT=0

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              MISSING_COUNT=$((MISSING_COUNT + 1))
            else
              echo "âœ… $file"
            fi
          done

          if [ $MISSING_COUNT -gt 0 ]; then
            echo "âŒ Missing $MISSING_COUNT required file(s)"
            exit 1
          fi

          echo "âœ… All required files present"

  generate-summary:
    name: Generate CI Summary
    runs-on: ubuntu-latest
    needs: [python-lint, terraform-validate, json-validation, security-check, documentation-check, file-structure]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate summary
        run: |
          echo "## ðŸ” CI Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Code Quality | ${{ needs.python-lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validation | ${{ needs.terraform-validate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Validation | ${{ needs.json-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.documentation-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Project Structure | ${{ needs.file-structure.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count files
          PROMPT_COUNT=$(find prompts/ -name "*.json" -type f 2>/dev/null | wc -l | tr -d ' ')
          TEMPLATE_COUNT=$(find prompt_templates/ -name "*.txt" -type f 2>/dev/null | wc -l | tr -d ' ')

          echo "### ðŸ“ˆ Repository Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Prompt Configurations:** $PROMPT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Templates:** $TEMPLATE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.python-lint.result }}" == "success" ] && \
             [ "${{ needs.terraform-validate.result }}" == "success" ] && \
             [ "${{ needs.json-validation.result }}" == "success" ] && \
             [ "${{ needs.security-check.result }}" == "success" ] && \
             [ "${{ needs.documentation-check.result }}" == "success" ] && \
             [ "${{ needs.file-structure.result }}" == "success" ]; then
            echo "âœ… **All checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some checks failed. Please review the errors above.**" >> $GITHUB_STEP_SUMMARY
          fi
