name: Process Prompts - Beta Deployment

on:
  pull_request:
    branches:
      - main
    paths:
      - 'prompts/**'
      - 'prompt_templates/**'
      - 'scripts/**'
      - '.github/workflows/on_pull_request.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  process-prompts-beta:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_BUCKET: ${{ secrets.S3_BUCKET_BETA }}
      S3_PREFIX: beta/

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate required secrets
        run: |
          echo "üîë Validating required GitHub secrets..."

          MISSING_SECRETS=()

          [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] && MISSING_SECRETS+=("AWS_ACCESS_KEY_ID")
          [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] && MISSING_SECRETS+=("AWS_SECRET_ACCESS_KEY")
          [ -z "${{ secrets.AWS_REGION }}" ] && MISSING_SECRETS+=("AWS_REGION")
          [ -z "${{ secrets.S3_BUCKET_BETA }}" ] && MISSING_SECRETS+=("S3_BUCKET_BETA")

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "‚ùå Missing required GitHub secrets:"
            printf '%s\n' "${MISSING_SECRETS[@]}"
            echo ""
            echo "Please configure the following secrets in your repository:"
            echo "Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            echo ""
            echo "Required secrets:"
            echo "  - AWS_ACCESS_KEY_ID: Your AWS access key"
            echo "  - AWS_SECRET_ACCESS_KEY: Your AWS secret key"
            echo "  - AWS_REGION: AWS region (e.g., us-east-1)"
            echo "  - S3_BUCKET_BETA: Beta S3 bucket name"
            echo ""
            echo "See DEPLOYMENT.md for detailed setup instructions."
            exit 1
          fi

          echo "‚úÖ All required secrets are configured"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Validate AWS credentials
        run: |
          echo "üîê Validating AWS credentials..."
          aws sts get-caller-identity

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.7.5'
          terraform_wrapper: false

      - name: Validate Terraform installation
        run: |
          echo "‚úÖ Terraform version:"
          terraform version

      - name: Terraform Format Check
        run: |
          echo "üßπ Checking Terraform formatting..."
          cd terraform
          terraform fmt -check -recursive

      - name: Create Terraform Variables File
        run: |
          cd terraform
          cat > terraform.tfvars <<EOF
          aws_region             = "${{ secrets.AWS_REGION }}"
          beta_bucket_name       = "${{ secrets.S3_BUCKET_BETA }}"
          prod_bucket_name       = "${{ secrets.S3_BUCKET_PROD }}"
          enable_public_access   = false
          enable_website_hosting = false
          project_name           = "PromptDeploymentPipeline"
          EOF

          echo "üìã Terraform variables configured"

      - name: Terraform Init
        run: |
          echo "‚öôÔ∏è  Initializing Terraform..."
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          echo "üîç Validating Terraform configuration..."
          cd terraform
          terraform validate

      - name: Terraform Plan
        run: |
          echo "üìù Planning infrastructure changes..."
          cd terraform
          terraform plan -var-file=terraform.tfvars -out=tfplan

      - name: Terraform Apply
        run: |
          echo "üöÄ Applying infrastructure changes..."
          cd terraform
          terraform apply -auto-approve tfplan

      - name: Capture Terraform Outputs
        id: tf_outputs
        run: |
          cd terraform
          echo "üì§ Capturing Terraform outputs..."

          BETA_BUCKET=$(terraform output -raw beta_bucket_name 2>/dev/null || echo "")
          PROD_BUCKET=$(terraform output -raw prod_bucket_name 2>/dev/null || echo "")

          echo "beta_bucket=$BETA_BUCKET" >> $GITHUB_OUTPUT
          echo "prod_bucket=$PROD_BUCKET" >> $GITHUB_OUTPUT

          echo "‚úÖ Beta Bucket: $BETA_BUCKET"
          echo "‚úÖ Prod Bucket: $PROD_BUCKET"

      - name: Find prompt configurations
        id: find_prompts
        run: |
          echo "üîç Finding prompt configuration files..."
          PROMPT_FILES=$(find prompts/ -name "*.json" -type f | tr '\n' ' ')

          if [ -z "$PROMPT_FILES" ]; then
            echo "‚ö†Ô∏è  No prompt files found in prompts/ directory"
            echo "prompt_files=" >> $GITHUB_OUTPUT
          else
            echo "Found prompt files: $PROMPT_FILES"
            echo "prompt_files=$PROMPT_FILES" >> $GITHUB_OUTPUT
          fi

      - name: Process prompts with Bedrock
        if: steps.find_prompts.outputs.prompt_files != ''
        run: |
          echo "üöÄ Processing prompts for BETA environment..."
          echo "üì¶ S3 Bucket: $S3_BUCKET"
          echo "üìÅ S3 Prefix: $S3_PREFIX"

          python scripts/process_prompt.py \
            ${{ steps.find_prompts.outputs.prompt_files }} \
            --region $AWS_REGION \
            --bucket $S3_BUCKET \
            --prefix $S3_PREFIX

      - name: Upload outputs as artifacts
        if: steps.find_prompts.outputs.prompt_files != ''
        uses: actions/upload-artifact@v4
        with:
          name: beta-outputs-${{ github.event.pull_request.number }}
          path: outputs/
          retention-days: 7

      - name: Generate deployment summary
        if: always()
        run: |
          echo "## üöÄ Infrastructure & Prompt Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Request:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Beta" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üèóÔ∏è Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Beta Bucket** | \`${{ steps.tf_outputs.outputs.beta_bucket }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Prod Bucket** | \`${{ steps.tf_outputs.outputs.prod_bucket }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **AWS Region** | \`${{ secrets.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.find_prompts.outputs.prompt_files }}" ]; then
            echo "### üìÑ Processed Prompts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            for file in ${{ steps.find_prompts.outputs.prompt_files }}; do
              filename=$(basename "$file")
              echo "- ‚úÖ \`$filename\`" >> $GITHUB_STEP_SUMMARY
            done

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîó Access Generated Content" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Generated files have been uploaded to:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "s3://$S3_BUCKET/$S3_PREFIX" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Generated outputs are available as workflow artifacts." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è No Prompts Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No prompt configuration files were found in the \`prompts/\` directory." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const promptFiles = '${{ steps.find_prompts.outputs.prompt_files }}'.split(' ').filter(f => f);

            let comment = `## üöÄ Infrastructure & Prompt Deployment Complete\n\n`;

            comment += `### üèóÔ∏è Infrastructure Deployed\n\n`;
            comment += `| Resource | Value |\n`;
            comment += `|----------|-------|\n`;
            comment += `| **Beta Bucket** | \`${{ steps.tf_outputs.outputs.beta_bucket }}\` |\n`;
            comment += `| **Prod Bucket** | \`${{ steps.tf_outputs.outputs.prod_bucket }}\` |\n`;
            comment += `| **AWS Region** | \`${{ secrets.AWS_REGION }}\` |\n`;
            comment += `| **Environment** | Beta |\n\n`;

            if (promptFiles.length > 0) {
              comment += `### üìÑ Processed Prompts\n\n`;
              promptFiles.forEach(file => {
                const filename = file.split('/').pop();
                comment += `- ‚úÖ \`${filename}\`\n`;
              });

              comment += `\n### üîó Access URLs\n\n`;
              comment += `Generated content is available at:\n`;
              comment += `\`\`\`\n`;
              comment += `s3://${{ secrets.S3_BUCKET_BETA }}/beta/outputs/\n`;
              comment += `\`\`\`\n\n`;
            } else {
              comment += `### ‚ö†Ô∏è No Prompts Processed\n\n`;
              comment += `No prompt configuration files were found in the \`prompts/\` directory.\n\n`;
            }

            comment += `### ‚úÖ Next Steps\n\n`;
            comment += `1. Review the deployed infrastructure and generated content\n`;
            comment += `2. If satisfied, merge this PR to deploy to production\n`;
            comment += `3. Production deployment will use the \`prod/\` prefix\n`;
            comment += `4. Infrastructure changes are already applied to both environments\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: No prompts found
        if: steps.find_prompts.outputs.prompt_files == ''
        run: |
          echo "‚ö†Ô∏è  No prompt configuration files found"
          echo "Please add JSON files to the prompts/ directory"
